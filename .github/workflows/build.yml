name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build Grain.app
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: Cache Xcode Derived Data
      uses: actions/cache@v3
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
    
    - name: Build Project
      run: |
        # Build from Xcode project
        xcodebuild -project GrainAI/GrainAI.xcodeproj \
                   -scheme GrainAI \
                   -sdk macosx \
                   -configuration Debug \
                   -arch arm64 \
                   -derivedDataPath ./DerivedData \
                   clean build \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
      env:
        CI: true
    
    - name: Build Artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: Grain-MacOS
        path: DerivedData/Build/Products/Debug/GrainAI.app
        retention-days: 7

  lint:
    name: SwiftLint
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: swiftlint lint --strict

  validate-swift-package:
    name: Validate Package.swift
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Package
      run: swift build
    
    - name: Test Package
      if: success()
      run: swift test

  create-release:
    name: Create Release Package
    runs-on: macos-13
    needs: [build, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: Build Release
      run: |
        xcodebuild -project GrainAI/GrainAI.xcodeproj \
                   -scheme GrainAI \
                   -sdk macosx \
                   -configuration Release \
                   -arch arm64 \
                   -derivedDataPath ./DerivedData \
                   clean build \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
    
    - name: Create DMG
      run: |
        # Create DMG for distribution
        hdiutil create -volname "Grain" -srcfolder "DerivedData/Build/Products/Release/GrainAI.app" -ov -format UDZO Grain-macOS.dmg
    
    - name: Upload Release Asset
      uses: actions/upload-artifact@v3
      with:
        name: Grain-Release-DMG
        path: Grain-macOS.dmg
        retention-days: 30
    
    - name: Archive Build
      uses: actions/upload-artifact@v3
      with:
        name: Grain-Release-App
        path: DerivedData/Build/Products/Release/GrainAI.app
        retention-days: 30
